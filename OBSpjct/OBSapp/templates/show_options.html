{% load static %}

<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=9ec15cee8f9a36012166f2c377d167d7"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
    <title>Document</title>
    <link href="{% static 'css/1.css'%}" rel="stylesheet">
</head>
<body>
<div align = "middle" id = "wrapper">
    <br><br>
    SHOW OPTIONS
    <br>

    <img src = "{% static 'graphimage.png'%}" alt = "" width = "550" height="550">
    <br>
    
    {% if ifCS2 == "True" %}
        <h4>found {{lenCS2}} CS2</h4>
        <br>
        {% for cs2 in CS2 %}
            {{cs2.7}} / {{cs2.4}}m from Starting_Point / lat : {{cs2.11}}, lng : {{cs2.10}}
            <br>
        {% endfor %}
    {% endif %}
    <br>
    
    {% if ifMT1 == "True" %}
        <h4>found {{lenMT1}} MT1</h4>
        <br>
        {% for mt1 in MT1 %}
            {{mt1.7}} / {{mt1.4}}m from Starting_Point / lat : {{mt1.11}}, lng : {{mt1.10}}
            <br>
        {% endfor %}
    {% endif %}

    {% if ifMT1 != 'True' and ifCS2 != 'True' %}
        None Selected
    {% endif %}

    <br><br>

    <div id="map" style="width:100%; height:300px;"></div>
    <button type="button" onclick="setMarkersBound();">setMarkersBound</button>
    <button type="button" onclick="showCS2();">show CS2</button>
    <button type="button" onclick="hideCS2();">hide CS2</button>
    <button type="button" onclick="showMT1();">show MT1</button>
    <button type="button" onclick="hideMT1();">hide MT1</button>
    <br><br>
    <form action = "{% url 'end' %}">
        <button type="submit" class="btn btn-primary btn-lg">end</button>
    </form>

<script>
    var SPL = String("{{SPL.0}}").split(", ");
    var startMarkerlat = parseFloat(SPL[0]);
    var startMarkerlng = parseFloat(SPL[1]);
    var DPL = String("{{DPL.0}}").split(", ");
    var arriveMarkerlat = parseFloat(DPL[0]);
    var arriveMarkerlng = parseFloat(DPL[1]);
    var mapContainer = document.getElementById('map'), // 지도를 표시할 div 
        mapOption = { 
            center: new kakao.maps.LatLng((startMarkerlat + arriveMarkerlat)/2, (startMarkerlng+arriveMarkerlng)/2),
            level: 3 // 지도의 확대 레벨
        };
    var map = new kakao.maps.Map(mapContainer, mapOption); // 지도를 생성합니다
    var startSrc = 'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/red_b.png', // 출발 마커이미지의 주소입니다    
        startSize = new kakao.maps.Size(50, 45), // 출발 마커이미지의 크기입니다 
        startOption = { 
            offset: new kakao.maps.Point(15, 43) // 출발 마커이미지에서 마커의 좌표에 일치시킬 좌표를 설정합니다 (기본값은 이미지의 가운데 아래입니다)
        };
    // 출발 마커 이미지를 생성합니다
    var startImage = new kakao.maps.MarkerImage(startSrc, startSize, startOption);
    var startDragSrc = 'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/red_drag.png', // 출발 마커의 드래그 이미지 주소입니다    
        startDragSize = new kakao.maps.Size(50, 64), // 출발 마커의 드래그 이미지 크기입니다 
        startDragOption = { 
            offset: new kakao.maps.Point(15, 54) // 출발 마커의 드래그 이미지에서 마커의 좌표에 일치시킬 좌표를 설정합니다 (기본값은 이미지의 가운데 아래입니다)
        };
    // 출발 마커의 드래그 이미지를 생성합니다
    var startDragImage = new kakao.maps.MarkerImage(startDragSrc, startDragSize, startDragOption);
    // 출발 마커가 표시될 위치입니다 
    var startPosition = new kakao.maps.LatLng(startMarkerlat, startMarkerlng); 
    // 출발 마커를 생성합니다
    var startMarker = new kakao.maps.Marker({
        map: map, // 출발 마커가 지도 위에 표시되도록 설정합니다
        position: startPosition,
        draggable: false, // 출발 마커가 드래그 가능하도록 설정합니다
        image: startImage // 출발 마커이미지를 설정합니다
    });
    // 출발 마커에 dragstart 이벤트를 등록합니다
    kakao.maps.event.addListener(startMarker, 'dragstart', function() {
        // 출발 마커의 드래그가 시작될 때 마커 이미지를 변경합니다
        startMarker.setImage(startDragImage);
    });
    // 출발 마커에 dragend 이벤트를 등록합니다
    kakao.maps.event.addListener(startMarker, 'dragend', function() {
        // 출발 마커의 드래그가 종료될 때 마커 이미지를 원래 이미지로 변경합니다
        startMarker.setImage(startImage);
    });
    var arriveSrc = 'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/blue_b.png', // 도착 마커이미지 주소입니다    
    arriveSize = new kakao.maps.Size(50, 45), // 도착 마커이미지의 크기입니다 
    arriveOption = { 
        offset: new kakao.maps.Point(15, 43) // 도착 마커이미지에서 마커의 좌표에 일치시킬 좌표를 설정합니다 (기본값은 이미지의 가운데 아래입니다)
    };
    // 도착 마커 이미지를 생성합니다
    var arriveImage = new kakao.maps.MarkerImage(arriveSrc, arriveSize, arriveOption);
    var arriveDragSrc = 'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/blue_drag.png', // 도착 마커의 드래그 이미지 주소입니다    
        arriveDragSize = new kakao.maps.Size(50, 64), // 도착 마커의 드래그 이미지 크기입니다 
        arriveDragOption = { 
            offset: new kakao.maps.Point(15, 54) // 도착 마커의 드래그 이미지에서 마커의 좌표에 일치시킬 좌표를 설정합니다 (기본값은 이미지의 가운데 아래입니다)
        };
    // 도착 마커의 드래그 이미지를 생성합니다
    var arriveDragImage = new kakao.maps.MarkerImage(arriveDragSrc, arriveDragSize, arriveDragOption);
    // 도착 마커가 표시될 위치입니다 
    var arrivePosition = new kakao.maps.LatLng(arriveMarkerlat, arriveMarkerlng);    
    // 도착 마커를 생성합니다 
    var arriveMarker = new kakao.maps.Marker({  
        map: map, // 도착 마커가 지도 위에 표시되도록 설정합니다
        position: arrivePosition,
        draggable: false, // 도착 마커가 드래그 가능하도록 설정합니다
        image: arriveImage // 도착 마커이미지를 설정합니다
    });
    // 일반 지도와 스카이뷰로 지도 타입을 전환할 수 있는 지도타입 컨트롤을 생성합니다
    var mapTypeControl = new kakao.maps.MapTypeControl();
    // 지도에 컨트롤을 추가해야 지도위에 표시됩니다
    // kakao.maps.ControlPosition은 컨트롤이 표시될 위치를 정의하는데 TOPRIGHT는 오른쪽 위를 의미합니다
    map.addControl(mapTypeControl, kakao.maps.ControlPosition.TOPRIGHT);
    // 지도 확대 축소를 제어할 수 있는  줌 컨트롤을 생성합니다
    var zoomControl = new kakao.maps.ZoomControl();
    map.addControl(zoomControl, kakao.maps.ControlPosition.RIGHT);

    var CS2lst0 = "{{CS2str0}}".split(", ");
    var CS2lst1 = "{{CS2str1}}".split(", ");
    var CS2lst2 = "{{CS2str2}}".split(", ");
    var CS2lst3 = "{{CS2str3}}".split(", ");
    var CS2lst4 = "{{CS2str4}}".split(", ");
    var CS2lst5 = "{{CS2str5}}".split(", ");
    var CS2lst6 = "{{CS2str6}}".split(", ");
    var CS2lst7 = "{{CS2str7}}".split(", ");
    var CS2lst8 = "{{CS2str8}}".split(", ");
    var CS2lst9 = "{{CS2str9}}".split(", ");
    var CS2lst10 = "{{CS2str10}}".split(", ");
    var CS2lst11 = "{{CS2str11}}".split(", ");
    for (i = 0; i < CS2lst0.length; i++) {        
        CS2lst0[i] = CS2lst0[i].slice(6, -6)
    }
    for (i = 0; i < CS2lst1.length; i++) {        
        CS2lst1[i] = CS2lst1[i].slice(6, -6)
    }
    for (i = 0; i < CS2lst2.length; i++) {        
        CS2lst2[i] = CS2lst2[i].slice(6, -6)
    }
    for (i = 0; i < CS2lst3.length; i++) {        
        CS2lst3[i] = CS2lst3[i].slice(6, -6)
    }
    for (i = 0; i < CS2lst4.length; i++) {        
        CS2lst4[i] = CS2lst4[i].slice(6, -6)
    }
    for (i = 0; i < CS2lst5.length; i++) {        
        CS2lst5[i] = CS2lst5[i].slice(6, -6)
    }
    for (i = 0; i < CS2lst6.length; i++) {        
        CS2lst6[i] = CS2lst6[i].slice(6, -6)
    }
    for (i = 0; i < CS2lst7.length; i++) {        
        CS2lst7[i] = CS2lst7[i].slice(6, -6)
    }
    for (i = 0; i < CS2lst8.length; i++) {        
        CS2lst8[i] = CS2lst8[i].slice(6, -6)
    }
    for (i = 0; i < CS2lst9.length; i++) {        
        CS2lst9[i] = CS2lst9[i].slice(6, -6)
    }
    for (i = 0; i < CS2lst10.length; i++) {        
        CS2lst10[i] = CS2lst10[i].slice(6, -6)
    }
    for (i = 0; i < CS2lst11.length; i++) {        
        CS2lst11[i] = CS2lst11[i].slice(6, -6)
    }
    var MT1lst0 = "{{MT1str0}}".split(", ");
    var MT1lst1 = "{{MT1str1}}".split(", ");
    var MT1lst2 = "{{MT1str2}}".split(", ");
    var MT1lst3 = "{{MT1str3}}".split(", ");
    var MT1lst4 = "{{MT1str4}}".split(", ");
    var MT1lst5 = "{{MT1str5}}".split(", ");
    var MT1lst6 = "{{MT1str6}}".split(", ");
    var MT1lst7 = "{{MT1str7}}".split(", ");
    var MT1lst8 = "{{MT1str8}}".split(", ");
    var MT1lst9 = "{{MT1str9}}".split(", ");
    var MT1lst10 = "{{MT1str10}}".split(", ");
    var MT1lst11 = "{{MT1str11}}".split(", ");
    for (i = 0; i < MT1lst0.length; i++) {        
        MT1lst0[i] = MT1lst0[i].slice(6, -6)
    }
    for (i = 0; i < MT1lst1.length; i++) {        
        MT1lst1[i] = MT1lst1[i].slice(6, -6)
    }
    for (i = 0; i < MT1lst2.length; i++) {        
        MT1lst2[i] = MT1lst2[i].slice(6, -6)
    }
    for (i = 0; i < MT1lst3.length; i++) {        
        MT1lst3[i] = MT1lst3[i].slice(6, -6)
    }
    for (i = 0; i < MT1lst4.length; i++) {        
        MT1lst4[i] = MT1lst4[i].slice(6, -6)
    }
    for (i = 0; i < MT1lst5.length; i++) {        
        MT1lst5[i] = MT1lst5[i].slice(6, -6)
    }
    for (i = 0; i < MT1lst6.length; i++) {        
        MT1lst6[i] = MT1lst6[i].slice(6, -6)
    }
    for (i = 0; i < MT1lst7.length; i++) {        
        MT1lst7[i] = MT1lst7[i].slice(6, -6)
    }
    for (i = 0; i < MT1lst8.length; i++) {        
        MT1lst8[i] = MT1lst8[i].slice(6, -6)
    }
    for (i = 0; i < MT1lst9.length; i++) {        
        MT1lst9[i] = MT1lst9[i].slice(6, -6)
    }
    for (i = 0; i < MT1lst10.length; i++) {        
        MT1lst10[i] = MT1lst10[i].slice(6, -6)
    }
    for (i = 0; i < MT1lst11.length; i++) {        
        MT1lst11[i] = MT1lst11[i].slice(6, -6)
    }
    var markers = [];
    markers.push(startMarker);
    markers.push(arriveMarker);
    var CS2markers = [];
    var MT1markers = [];
    var CS2overlays = [];
    var MT1overlays = [];
    
    var CS2imageSrc = 'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/places_category.png'; // 마커 이미지 url, 스프라이트 이미지를 씁니다
    var CS2imageSize = new kakao.maps.Size(27, 28);  // 마커 이미지의 크기
    var CS2imgOptions =  {
            spriteSize : new kakao.maps.Size(72, 208), // 스프라이트 이미지의 크기
            spriteOrigin : new kakao.maps.Point(46, (5*36)), // 스프라이트 이미지 중 사용할 영역의 좌상단 좌표
            offset: new kakao.maps.Point(11, 28) // 마커 좌표에 일치시킬 이미지 내에서의 좌표
        };
    var CS2markerImage = new kakao.maps.MarkerImage(CS2imageSrc, CS2imageSize, CS2imgOptions)

    var MT1imageSrc = 'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/places_category.png'; // 마커 이미지 url, 스프라이트 이미지를 씁니다
    var MT1imageSize = new kakao.maps.Size(27, 28);  // 마커 이미지의 크기
    var MT1imgOptions =  {
            spriteSize : new kakao.maps.Size(72, 208), // 스프라이트 이미지의 크기
            spriteOrigin : new kakao.maps.Point(46, (1*36)), // 스프라이트 이미지 중 사용할 영역의 좌상단 좌표
            offset: new kakao.maps.Point(11, 28) // 마커 좌표에 일치시킬 이미지 내에서의 좌표
        };
    var MT1markerImage = new kakao.maps.MarkerImage(MT1imageSrc, MT1imageSize, MT1imgOptions)

    for (x = 0; x < CS2lst10.length; x++) {
        var CS2position = new kakao.maps.LatLng(parseFloat(CS2lst11[x]), parseFloat(CS2lst10[x]));
        
        var CS2marker = new kakao.maps.Marker({
            map:map,
            position:CS2position,
            draggable:false,
            image: CS2markerImage
        })

        if (CS2lst6[x]) {
            var content = '<div class="wrap">' + 
            '    <div class="info">' + 
            '        <div class="title">' + 
                        CS2lst7[x] + 
            '            <div class="close" id="ovly" onclick = "closeCS2Overlay(' + x + ');" title="닫기"></div>' + 
            '        </div>' + 
            '        <div class="body">' + 
            '            <div class="desc">' + 
            '                <div class="ellipsis">' + CS2lst9[x] + '</div>' + 
            '                <div class="jibun ellipsis">(지번) ' + CS2lst0[x] + '</div>' + 
            '                <div class="ellipsis">' + CS2lst6[x] + ' 대표번호</div>' +
            '                <div><a href=' + CS2lst8[x] + ' ' +  'target="_blank" class="link">홈페이지</a></div>' + 
            '            </div>' + 
            '        </div>' + 
            '    </div>' +    
            '</div>';
        }

        //대표번호 없으면
        else {
            var content = '<div class="wrap">' + 
            '    <div class="info">' + 
            '        <div class="title">' + 
                        CS2lst7[x] + 
            '            <div class="close" id="ovly" onclick = "closeCS2Overlay(' + x + ');" title="닫기"></div>' + 
            '        </div>' + 
            '        <div class="body">' + 
            '            <div class="desc">' + 
            '                <div class="ellipsis">' + CS2lst9[x] + '</div>' + 
            '                <div class="jibun ellipsis">(지번) ' + CS2lst0[x] + '</div>' + 
            '                <div><a href=' + CS2lst8[x] + ' ' +  'target="_blank" class="link">홈페이지</a></div>' + 
            '            </div>' + 
            '        </div>' + 
            '    </div>' +    
            '</div>';
        }
        
        var CS2overlay = new kakao.maps.CustomOverlay({
            content: content,
            position: CS2marker.getPosition(),       
            map: map,
        });   

        CS2overlays.push(CS2overlay);

        if (isNaN(Object.values(CS2position)[0])) {}        //position이 NaN이면 마커 리스트에 푸시 X, 안하면 바운드가 꺠짐 
        else {
            CS2markers.push(CS2marker);
            markers.push(CS2marker);
        }
        
    }
    
    for (y = 0; y < MT1lst10.length; y++) {
        var MT1position = new kakao.maps.LatLng(parseFloat(MT1lst11[y]), parseFloat(MT1lst10[y]));
        var MT1marker = new kakao.maps.Marker({
            map:map,
            position:MT1position,
            draggable:false,
            image: MT1markerImage
        })

        //대표번호 있으면
        if (MT1lst6[y]) {
            var content = '<div class="wrap">' + 
            '    <div class="info">' + 
            '        <div class="title">' + 
                        MT1lst7[y] + 
            '            <div class="close" id="ovly" onclick = "closeMT1Overlay(' + y + ');" title="닫기"></div>' + 
            '        </div>' + 
            '        <div class="body">' + 
            '            <div class="desc">' + 
            '                <div class="ellipsis">' + MT1lst9[y] + '</div>' + 
            '                <div class="jibun ellipsis">(지번) ' + MT1lst0[y] + '</div>' + 
            '                <div class="ellipsis">' + MT1lst6[y] + ' 대표번호</div>' +
            '                <div><a href=' + MT1lst8[y] + ' ' +  'target="_blank" class="link">홈페이지</a></div>' + 
            '            </div>' + 
            '        </div>' + 
            '    </div>' +    
            '</div>';
        }

        //대표번호 없으면
        else {
            var content = '<div class="wrap">' + 
            '    <div class="info">' + 
            '        <div class="title">' + 
                        MT1lst7[y] + 
            '            <div class="close" id="ovly" onclick = "closeMT1Overlay(' + y + ');" title="닫기"></div>' + 
            '        </div>' + 
            '        <div class="body">' + 
            '            <div class="desc">' + 
            '                <div class="ellipsis">' + MT1lst9[y] + '</div>' + 
            '                <div class="jibun ellipsis">(지번) ' + MT1lst0[y] + '</div>' + 
            '                <div><a href=' + MT1lst8[y] + ' ' +  'target="_blank" class="link">홈페이지</a></div>' + 
            '            </div>' + 
            '        </div>' + 
            '    </div>' +    
            '</div>';
        }
        
        // 마커 위에 커스텀오버레이를 표시합니다
        // 마커를 중심으로 커스텀 오버레이를 표시하기위해 CSS를 이용해 위치를 설정했습니다
        var MT1overlay = new kakao.maps.CustomOverlay({
            content: content,
            position: MT1marker.getPosition(),       
            map: map,
        });   
           
        kakao.maps.event.addListener(MT1marker, 'click', function() {
            MT1overlay.setMap(map);
        });
        MT1overlays.push(MT1overlay);
        // 마커를 클릭했을 때 커스텀 오버레이를 표시합니다
        
        //없는 포지션 푸시해서 setBound하면 지도 꺠져서
        if (isNaN(Object.values(MT1position)[0])){}
        else {
            markers.push(MT1marker);    
            MT1markers.push(MT1marker); 
        }
    }    
    for (i=0; i<MT1overlays.length; i++) {

    };

    // // 커스텀 오버레이를 닫기 위해 호출되는 함수입니다 
    function closeMT1Overlay(y){
        MT1overlays[y].setMap(null);
    }
    function closeCS2Overlay(y){
        CS2overlays[y].setMap(null);
    }

    var bounds = new kakao.maps.LatLngBounds();
    
    function setMarkersBound() {
        for (i = 0; i < markers.length; i++) {
            bounds.extend(markers[i].getPosition());
        }
        map.setBounds(bounds);
    }

    function showCS2() {
        for (i = 0; i < CS2markers.length; i++) {
            CS2markers[i].setMap(map);
        }
    }

    function hideCS2 () {
        for (i = 0; i < CS2markers.length; i++) {
            CS2markers[i].setMap(null);
        }
        for (p = 0; p < CS2overlays.length; p++) {
            CS2overlays[p].setMap(null);
        }
    }

    function showMT1 () {
        for (i = 0; i < MT1markers.length; i++) {
            MT1markers[i].setMap(map);
        }
    }

    function hideMT1 () {
        for (i = 0; i < MT1markers.length; i++) {
            MT1markers[i].setMap(null);
        }
        for (p = 0; p < MT1overlays.length; p++) {
            MT1overlays[p].setMap(null);
        }
    }



</script>
</div>
</body>
</html>